local http = require "http"
local nmap = require "nmap"
local shortport = require "shortport"
local strbuf = require "strbuf"
local vulns = require "vulns"
-- local rand = require "rand"



description = [[
Script to finger if a Gitlab instance is of a version that is vulnerable to CVE-2021-22205
]]

---
--@output

author = "Frank Breedijk of Dutch Institute for Vulnerability Disclosure (DIVD.nl)"
last_update = "November 27, 2021"
license = "Apache 2.0 - See http://www.apache.org/licenses/LICENSE-2.0"
categories = {"default", "discovery", "safe", "vuln" }

portrule = shortport.port_or_service( {80, 443}, {"http", "https"}, "tcp", "open")

local last_len = 0

function split(source, delimiters)
    local elements = {}
    local pattern = '([^'..delimiters..']+)'
    string.gsub(source, pattern, function(value) elements[#elements + 1] =     value;  end);
    return elements
end

function test(host, port, uri)
  options = {header={}}    
  options['header']['User-Agent'] = "Mozilla/5.0 (CVE-2021-31195 vulnerability check)"
  local answer = http.get(host, port, uri, options, false)

  if answer.status == 200 then
    return true
  else
    return false
  end
end

action = function(host, port, redirects)
--  local dis_count, noun

--  local randomname = ".divd." .. rand.random_string(16,'abcdefghijklmnopqrstuvwxyz1234567890') .. ".dtd"
  local vuln = {
    title = "GitLab CVE-2021-22205 - Remote Code Execution vulnerability in GitLab",
    state = vulns.STATE.NOT_VULN,
    description = [[
        When uploading image files, GitLab Workhorse passes any files with the extensions jpg|jpeg|tiff through to ExifTool to remove any non-whitelisted tags.
        An issue with this is that ExifTool will ignore the file extension and try to determine what the file is based on the content, allowing for any of the supported parsers to be hit instead of just JPEG and TIFF by just renaming the uploaded file.
        One of the supported formats is DjVu. When parsing the DjVu annotation, the tokens are evaled to "convert C escape sequences".
        There is some validation to try and ensure that everything is properly escaped, but a backslash followed by a newline is correctly handled allowing the quotes to be closed and arbitrary perl inserted and evaluated
      ]],
    IDS = {
        CVE = "CVE-2021-22205"
    },
    references = {
        'https://gitlab.com/gitlab-org/gitlab/-/issues/327121',
        'https://censys.io/blog/cve-2021-22205-it-was-a-gitlab-smash/',
        'https://csirt.divd.nl/cases/DIVD-2021-00030/'
    },
    dates = {
        disclosure = { year = '2021', month = '04', day = '07' }
    }
  }
  local vuln_report = vulns.Report:new(SCRIPT_NAME, host, port)

  local v_level = nmap.verbosity() + (nmap.debugging()*2)
  --local output = strbuf.new()
  local detail = 15



  if test(host,port,"/assets/application-67ac5da9c95d82e894c9efe975335f9e8bdae64967f33652cd9a97b5449216d2.css") then
    version = "11.1"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-93ebf32a4bd988b808c2329308847edd77e752b38becc995970079a6d586c39b.css") then
    version = "11.10"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-2eaf7e76aa55726cc0419f604e58ee73c5578c02c9e21fdbe7ae887925ea92ae.css") then
    version = "11.10.0-rc7.ce.0"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-38981e26a24308976f3a29d6e5e2beef57c7acda3ad0d5e7f6f149d58fd09d3d.css") then
    version = "11.10.5-ce.0"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-5440e2dd89d3c803295cc924699c93eb762e75d42178eb3fe8b42a5093075c71.css") then
    version = "11.11"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-9c095c833db4364caae1659f4e4dcb78da3b5ec5e9a507154832126b0fe0f08e.css") then
    version = "11.11.0-rc1.ce.0"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-34031b465d912c7d03e815c7cfaff77a3fa7a9c84671bb663026d36b1acd3f86.css") then
    version = "11.11.0-rc4"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-3cbf1ae156fa85f16d4ca01321e0965db8cfb9239404aaf52c3cebfc5b4493fb.css") then
    version = "11.9"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-292ca64c0c109481b0855aea6b883a588bd293c6807e9493fc3af5a16f37f369.css") then
    version = "11.9.0"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-77566acc818458515231d0a82c131a42890d771ea998b9f578dc38e0eb7e517f.css") then
    version = "12.0"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-78812856e55613c6803ecb31cc1864b7555bf7f0126d1dfa6f37376d37d3aeab.css") then
    version = "12.1"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-340c31a75c5150c5e501ec143849adbed26fed0da5a5ee8c60fb928009ea3b86.css") then
    version = "12.1.0-ce.0"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-d56f0577fbbbd6f159e9be00b274270cb25b60a7809871a6a572783b533f5a3c.css") then
    version = "12.2"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-def1880ada798c68ee010ba2193f53a2c65a8981871a634ae7e18ccdcd503fa3.css") then
    version = "12.3"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-3407a4fd892e9d5024f3096605eb1e25cad75a8bf847d26740a1e6a77e45b087.css") then
    version = "12.4"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-d812b9bf6957fafe35951054b9efc5be6b10c204c127aa5a048506218c34e40f.css") then
    version = "12.5"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-73a21594461cbc9a2fb00fc6f94aec1a33ccf435a7d008d764ddd0482e08fc8d.css") then
    version = "12.5.0-ce.0"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-aeddf31361633b3d1196c6483f25c484855e0f243e7f7e62686a4de9e10ec03b.css") then
    version = "12.6"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-bec9544b57b8b2b515e855779735ad31c3eacf65d615b4bfbd574549735111e7.css") then
    version = "12.7"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-39fdbd63424a09b5b065a6cc60c9267d3f49950bf1f1a7fd276fe1ece4a35c09.css") then
    version = "12.7.0-ce.0"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-dc6b3e9c0fad345e7c45a569f4c34c3e94730c33743ae8ca055aa6669ad6ac56.css") then
    version = "12.8"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-4a081f9e3a60a0e580cad484d66fbf5a1505ad313280e96728729069f87f856e.css") then
    version = "12.8.0-ce.0"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-45b2cf643afd34888294a073bf55717ea00860d6a1dca3d301ded1d0040cac44.css") then
    version = "12.9"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-450cbe5102fb0f634c533051d2631578c8a6bae2c4ef1c2e50d4bfd090ce3b54.css") then
    version = "12.10"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-c8d8d30d89b00098edab024579a3f3c0df2613a29ebcd57cdb9a9062675558e4.css") then
    version = "13.0"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-4abc4e078df94075056919bd59aed6e7a0f95067039a8339b8f614924d8cb160.css") then
    version = "13.1"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-ec9dfedd7bd44754668b208858a31b83489d5474f7606294f6cc0128bb218c6d.css") then
    version = "13.1.0-ce.0"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-a9308f85e95b00007892d451fd9f6beabcd8792b4c5f8cd7524ba7e941d479c9.css") then
    version = "13.2"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-f154ef27cf0f1383ba4ca59531058312b44c84d40938bc8758827023db472812.css") then
    version = "13.2.0-ce.0"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-455d114267e5992b858fb725de1c1ddb83862890fe54436ffea5ff2d2f72edc8.css") then
    version = "13.3"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-7f1c7b2bfaa6152740d453804e7aa380077636cad101005ed85e70990ec20ec5.css") then
    version = "13.3.8-ce.0"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-969119f639d0837f445a10ced20d3a82d2ea69d682a4e74f39a48a4e7b443d5e.css") then
    version = "13.4"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-f9ab217549b223c55fa310f2007a8f5685f9596c579f5c5526e7dcb204ba0e11.css") then
    version = "13.4.0-ce.0"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-be9a23d3021354ec649bc823b23eab01ed235a4eb730fd2f4f7cdb2a6dee453a.css") then
    version = "13.5"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-bf1ba5d5d3395adc5bad6f17cc3cb21b3fb29d3e3471a5b260e0bc5ec7a57bc4.css") then
    version = "13.5.0-ce.0"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-051048a171ccf14f73419f46d3bd8204aa3ed585a72924faea0192f53d42cfce.css") then
    version = "13.6"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-a0c92bafde7d93e87af3bc2797125cba613018240a9f5305ff949be8a1b16528.css") then
    version = "13.7"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-79837fd1939f90d58cc5a842a81120e8cecbc03484362e88081ebf3b7e3830e9.css") then
    version = "13.7.0-rc3.ce.0"
    vuln.state = vulns.STATE.VULN
  elseif test(host,port,"/assets/application-52560ba2603619d2ff1447002a60dcb62c7c957451fb820f1894e1ce7c23821c.css") then
    if test(host,port,"/assets/.sprockets-manifest-1a7806827e33003a7ad4eb90906b1041.json") then
        version = "13.8.x (but >= 13.8.8, so patched)"
    else
        version = "13.8.x (but < 13.8.8, so unpatched)"
        vuln.state = vulns.STATE.VULN
    end
  elseif test(host,port,"/assets/application-d161b6e25db66456f8e0603de5132d1ff90f9388d0a0305d2d073a67fd229ddb.css") then
    if test(host,port,"/assets/ .sprockets-manifest-60c45e92332b9f3346034ce9e497b48b.json") then
        version = "13.9.x (but >= 13.9.6, so patched)"
    else
        version = "13.9.x (but < 13.9.6, so unpatched)"
        vuln.state = vulns.STATE.VULN
    end
  elseif test(host,port,"/assets/application-02aa9533ec4957bb01d206d6eaa51d762c7b7396362f0f7a3b5fb4dd6088745b.css") then
    if test(host,port,"/assets/.sprockets-manifest-08d0cc671186f66876028c0b0edda109.json") then
        version = "13.10.x (but >= 13.10.3, so patched)"
    else
        version = "13.10.x (but < 13.10.3, so unpatched)"
        vuln.state = vulns.STATE.VULN
    end
  else
    version = "** No GitLab version detected **"
  end

  if vuln.state == vulns.STATE.VULN then
    vuln.description = "You are running Gitlab version: " .. version .. "\nThis version is VULNERABLE to " .. vuln['IDS']['CVE'] .. "\n" .. vuln.description
  else
    return "Exploitation of " .. vuln['IDS']['CVE'] .. " unsuccessful.\nVersion is:" .. version -- .. answer.body
  end

  return vuln_report:make_output(vuln)
end
